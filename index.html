<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Itinerario de Viaje a Asia 2025 (UTC)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/7.2.1/css/flag-icons.min.css" integrity="sha512-bZBu2H0+FGFz/stDN/L0k8J0G8qVsAL0ht1qg5kTwtAheiXwiRKyCq1frwfbSFSJN3jooR5kauE0YjtPzhZtJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- Global Styles & Theme --- */
        :root {
            --primary-color: #059669; /* Emerald-600 */
            --primary-light: #a7f3d0; /* Emerald-200 */
            --bg-color: #f8fafc; /* Slate-50 */
            --card-bg: #ffffff;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); }
        .leaflet-container { border-radius: 0.75rem; z-index: 1; }

        /* --- Loading State --- */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        #loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* --- Scrollbar Styles --- */
        .styled-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .styled-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .styled-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .styled-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Custom scrollbar hide utility for timeline */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- Itinerary Timeline Styles --- */
        .timeline-item-container { position: relative; padding-left: 60px; padding-bottom: 35px; cursor: pointer; transition: opacity 0.3s; }
        .timeline-item-container:hover { opacity: 0.85; }
        .timeline-item-container:last-child { padding-bottom: 10px; }
        .timeline-line { position: absolute; left: 25px; top: 15px; width: 2px; height: 100%; background-color: #e2e8f0; }
        .timeline-item-container:last-child .timeline-line {
            display: none; /* Hide the line after the last item */
        }

        .timeline-icon {
            position: absolute;
            left: 0;
            top: 10px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #e2e8f0; /* Softer default color */
            border: 3px solid var(--card-bg); /* Match card background to create space */
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            z-index: 5;
        }
        .timeline-item-container.active .timeline-icon {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-light);
            box-shadow: 0 4px 10px rgba(5, 150, 105, 0.3);
        }
        .material-symbols-outlined { font-size: 24px; }

        /* --- City Overview Timeline Styles --- */
        .city-timeline { position: relative; display: flex; justify-content: space-between; padding: 2rem 0; margin: 0 1rem; }
        .city-timeline::before { content: ''; position: absolute; top: 52px; left: 0; right: 0; height: 4px; background-color: #e2e8f0; z-index: 1; }
        .city-timeline-item { display: flex; flex-direction: column; align-items: center; position: relative; flex-grow: 1; z-index: 10; min-width: 110px; }
        .city-timeline-node { width: 44px; height: 44px; background-color: #fff; border-radius: 50%; border: 3px solid #cbd5e1; transition: border-color 0.3s ease, box-shadow 0.3s ease; flex-shrink: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);}

        .city-timeline-node .fi { font-size: 32px; line-height: 1em; }
        .city-timeline-node .fi-tw { transform: scale(1.4); }

        .city-timeline-item.active .city-timeline-node {
            border-color: var(--primary-color);
            box-shadow: 0 4px 10px rgba(5, 150, 105, 0.3);
        }
        .city-timeline-label { margin-top: 0.75rem; font-size: 0.875rem; font-weight: 600; color: #475569; transition: color 0.3s ease; text-align: center; }
        .city-timeline-item.active .city-timeline-label { color: var(--primary-color); font-weight: 700; }
        .stay-info { display: flex; gap: 0.4rem; margin-top: 0.25rem; color: #64748b; }
        .stay-info-item { display: flex; align-items: center; font-size: 0.8rem; }
        .stay-info-item span:first-child { margin-right: 4px; }
        .stay-info-item .material-symbols-outlined { font-size: 16px; }
        .half-day { margin-right: 0.25rem; }

        .timeline-connection {
            position: absolute;
            top: 0;
            left: 50%;
            width: 100%;
            height: 100%;
            z-index: 15;
            pointer-events: none; /* Allows clicks to pass through to the city item */
        }

        .transport-icon {
            position: absolute;
            top: 20px; /* Positioned relative to the item top, to be above the line */
            left: 50%;
            transform: translateX(-50%);
            background-color: #fff;
            border-radius: 50%;
            color: #64748b;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            pointer-events: auto;
        }
        .transport-icon .material-symbols-outlined { font-size: 18px; }

        .day-trip-node {
            position: absolute;
            top: 80px; /* Position below the timeline line */
            left: 25%; /* Position on the first half of the segment */
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none; /* Make it unclickable */
            cursor: default;
        }

        .day-trip-node .city-timeline-node {
            width: 24px;
            height: 24px;
            border-width: 2px;
        }

        .day-trip-node .city-timeline-label {
            font-weight: 500;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .day-trips-container-org {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding-left: 20px;
            margin-top: 10px;
            position: relative;
        }

        .day-trips-container-org::before {
            content: '';
            position: absolute;
            top: 0;
            left: 10px; /* Position of the vertical line */
            width: 2px;
            height: var(--line-height, 100%); /* Use CSS variable, with fallback */
            background-color: #e2e8f0; /* Same as timeline line */
        }

        .day-trip-item-org {
            display: flex;
            align-items: center;
            margin-bottom: 8px; /* Space between day trips */
            position: relative;
        }

        .day-trip-item-org .day-trip-icon {
            position: absolute;
            left: -19px; /* (icon_width / 2) + (line_width / 2) - padding_left */
            background-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day-trip-item-org .day-trip-icon .material-symbols-outlined {
            font-size: 14px;
        }

        .day-trip-item-org .day-trip-label {
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: 10px;
        }
        
        /* --- POI Styles (Accordion) --- */
        .poi-category h4 { font-weight: 600; color: #334155; background-color: #f1f5f9; padding: 0.75rem 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; }
        .poi-category h4:hover { background-color: #e2e8f0; }
        .poi-category h4 .icon-left { display: flex; align-items: center; }
        .poi-category h4 .material-symbols-outlined { font-size: 20px; margin-right: 8px; }
        .poi-count { font-size: 0.8rem; color: #94a3b8; margin-left: 8px; font-weight: 500; }
        /* Smooth accordion transition */
        .poi-list { max-height: 0; overflow: hidden; transition: max-height 0.5s cubic-bezier(0, 1, 0, 1); padding: 0 0.5rem; }
        .poi-list.open { max-height: 1500px; transition: max-height 0.5s ease-in-out; padding: 0.5rem; }
        .poi-item { margin-bottom: 1rem; padding-left: 1.5rem; border-left: 3px solid #e2e8f0; }
        .poi-name { font-weight: 500; }
        .poi-desc { font-size: 0.875rem; color: #64748b; }
        
        /* --- Map Marker Styles --- */
        .leaflet-div-icon { background: #fff; border: 2px solid #64748b; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
        .leaflet-div-icon .material-symbols-outlined { font-size: 18px; color: #64748b; }

        /* --- City Timeline Mobile Scroll --- */
        #city-timeline-container {
            position: relative;
        }
        .scroll-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 20;
            transition: opacity 0.2s;
        }
        .scroll-arrow:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .scroll-arrow.left { left: -10px; }
        .scroll-arrow.right { right: -10px; }

        /* --- City Timeline Responsive Behavior --- */
        @media (min-width: 1024px) {
            .city-timeline {
                flex-wrap: wrap;
                justify-content: center;
            }
            .scroll-arrow {
                display: none;
            }
        }

        /* --- Modal Accordion --- */
        .poi-category-details .poi-list-modal {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .poi-category-details[open] .poi-list-modal {
            max-height: 1000px; /* Arbitrary large value */
        }

        /* --- Atracciones Button --- */
        #poi-modal-btn {
            background-color: #60A5FA; /* A nice pastel blue - Tailwind's blue-400 */
            color: white;
        }
        #poi-modal-btn:hover {
            background-color: #3B82F6; /* Darker blue for hover - Tailwind's blue-500 */
        }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <div id="loading-overlay">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-emerald-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-slate-600">Cargando itinerario...</p>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-6 lg:p-8 pb-24 lg:pb-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-5xl font-extrabold text-slate-900 flex items-center justify-center gap-4">
                <span class="material-symbols-outlined text-emerald-600" style="font-size: 40px;">travel_explore</span>
                Itinerario de Viaje a Asia
            </h1>
            <p class="text-lg md:text-xl text-slate-600 mt-3">Septiembre 27 - Octubre 20, 2025 (Horarios en UTC)</p>
        </header>

        <div id="city-timeline-container" class="bg-white p-4 rounded-xl shadow-xl mb-8"></div>

        <main id="main-content" class="grid grid-cols-1 gap-8" style="display: none;">
            
            <!-- Unified Day-by-Day View -->
            <div id="day-view" class="col-span-1 space-y-6">
                <!-- Date Navigator -->
                <div id="date-nav" class="flex items-center justify-between bg-white p-4 rounded-xl shadow-lg">
                    <button id="prev-day" class="p-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-600 transition shadow-sm"><span class="material-symbols-outlined">chevron_left</span></button>
                    <div id="date-display" class="text-center">
                        <h3 class="text-lg font-bold text-slate-900"></h3>
                        <p class="text-sm text-slate-500"></p>
                    </div>
                    <button id="next-day" class="p-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-600 transition shadow-sm"><span class="material-symbols-outlined">chevron_right</span></button>
                </div>

                <!-- Content Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Itinerary List -->
                    <div id="itinerary-list" class="lg:col-span-1 bg-white p-6 rounded-xl shadow-xl"></div>

                    <!-- Map and Details Column -->
                    <div class="lg:col-span-2 space-y-8">
                        <!-- Action Buttons -->
                        <div class="flex justify-start gap-4">
                            <button id="poi-modal-btn" class="flex items-center gap-2 px-4 py-2 font-semibold rounded-lg shadow-md transition">
                                <span class="material-symbols-outlined">place</span>
                                Atracciones
                            </button>
                            <button id="filter-modal-btn" class="flex items-center gap-2 px-4 py-2 font-semibold rounded-lg shadow-md transition bg-white text-slate-700 hover:bg-slate-100 border border-slate-200">
                                <span class="material-symbols-outlined">filter_list</span>
                                Filtros
                            </button>
                        </div>
                         <!-- Map -->
                        <div id="map-container" class="w-full h-96 lg:h-[60vh] bg-white rounded-xl shadow-xl">
                             <div id="map" class="w-full h-full rounded-xl"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div id="modal-card" class="bg-white rounded-xl shadow-2xl w-full max-w-lg styled-scrollbar transform transition-transform duration-300 ease-out scale-95" style="max-height: 90vh;">
            <div class="flex justify-between items-center border-b p-4">
                <h3 id="modal-title" class="text-xl font-bold text-slate-800"></h3>
                <button id="modal-close-btn" class="p-2 rounded-full text-slate-500 hover:bg-slate-200 hover:text-slate-800 transition">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div id="modal-content" class="p-6 space-y-4" style="max-height: 75vh; overflow-y: auto;">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Filter Modal -->
    <div id="filter-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div id="filter-modal-card" class="bg-white rounded-xl shadow-2xl w-full max-w-md transform transition-transform duration-300 ease-out scale-95">
            <div class="flex justify-between items-center border-b p-4">
                <h3 class="text-xl font-bold text-slate-800">Filtrar Puntos de Interés</h3>
                <button id="filter-modal-close-btn" class="p-2 rounded-full text-slate-500 hover:bg-slate-200 hover:text-slate-800 transition">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div id="filter-modal-content" class="p-6" style="max-height: 70vh; overflow-y: auto;">
                <div class="flex items-center mb-4 pb-4 border-b border-slate-200">
                    <button id="filter-toggle-all-btn" class="flex items-center gap-2 text-sm font-semibold text-slate-700 hover:text-slate-900 transition">
                        <span id="filter-toggle-all-icon" class="material-symbols-outlined">check_box_outline_blank</span>
                        <span id="filter-toggle-all-text">Seleccionar todo</span>
                    </button>
                </div>
                <div id="filter-categories" class="grid grid-cols-2 gap-4">
                    <!-- Checkboxes will be injected here -->
                </div>
            </div>
            <div class="flex justify-end gap-4 border-t p-4">
                <button id="filter-apply-btn" class="px-4 py-2 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-700 transition">Aplicar</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA VARIABLES (To be populated by fetch) ---
        let itineraryData = [];
        let pointsOfInterest = {};
        let sortedData = [];
        let cityStays = {}; // Will be dynamically calculated

        // --- Configuration Constants ---
        const ITINERARY_URL = 'itinerary.json';
        const POI_URL = 'poi.json';

        const poiIcons = {
            'Actividad': 'local_activity',
            'Alojamiento': 'hotel',
            'Arte y Museos': 'museum',
            'Atracción': 'attractions',
            'Barrio': 'location_city',
            'Comida y Bebida': 'restaurant',
            'Compras': 'shopping_bag',
            'Consejo': 'lightbulb',
            'Evento': 'event',
            'Excursión de un día': 'tour',
            'Lugar de interés y Mirador': 'visibility',
            'Mercado': 'storefront',
            'Onsen y Spa': 'spa',
            'Playa': 'beach_access',
            'Templos y Santuarios': 'temple_buddhist',
            'Transporte': 'commute'
        };

        const icons = {
            flight: `<span class="material-symbols-outlined">flight</span>`,
            flight_arrival: `<span class="material-symbols-outlined">flight_land</span>`,
            lodging: `<span class="material-symbols-outlined">hotel</span>`,
            sleep: `<span class="material-symbols-outlined">dark_mode</span>`,
            transport: `<span class="material-symbols-outlined">train</span>`,
            activity: `<span class="material-symbols-outlined">local_activity</span>`,
            daytrip: `<span class="material-symbols-outlined">holiday_village</span>`,
            business: `<span class="material-symbols-outlined">work</span>`,
        };
        
        const transportIcons = {
            flight: 'flight_takeoff',
            train: 'train',
        };

        // Flags configuration using flag-icon-css library classes (fi fi-xx)
        const rawCountryFlags = {
            "Tokyo": `<span class="fi fi-jp"></span>`,
            "Hakone": `<span class="fi fi-jp"></span>`,
            "Nara": `<span class="fi fi-jp"></span>`,
            "Kyoto": `<span class="fi fi-jp"></span>`,
            "Osaka": `<span class="fi fi-jp"></span>`,
            "Okinawa": `<span class="fi fi-jp"></span>`,
            "Busan": `<span class="fi fi-kr"></span>`,
            "Gyeongju": `<span class="fi fi-kr"></span>`,
            "Seoul": `<span class="fi fi-kr"></span>`,
            "Taipei": `<span class="fi fi-tw"></span>`,
        };

        // --- Helper Functions ---
        function normalizeStr(str) {
            if (typeof str !== 'string') return str;
            return str.normalize('NFC').trim();
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // Normalize the keys of the flags object for robust matching
        const countryFlags = Object.keys(rawCountryFlags).reduce((acc, key) => {
            acc[normalizeStr(key)] = rawCountryFlags[key];
            return acc;
        }, {});


        // --- Initialization & Setup ---
        const LG_BREAKPOINT = 1024;
        let isMobile = window.innerWidth < LG_BREAKPOINT;
        
        const loadingOverlay = document.getElementById('loading-overlay');
        const mainContent = document.getElementById('main-content');
        const itineraryList = document.getElementById('itinerary-list');
        const mapContainer = document.getElementById('map-container');
        const prevDayBtn = document.getElementById('prev-day');
        const nextDayBtn = document.getElementById('next-day');
        const dateDisplay = document.getElementById('date-display');
        const cityTimelineContainer = document.getElementById('city-timeline-container');
        
        // --- State Variables ---
        let currentDayIndex = 0;
        let cityPageIndex = 0;
        let groupedByDay = [];
        let mainMarker = null;
        let map;
        let poiLayerGroup;
        let activeFilters = [];

        // --- COORDINATE PARSING & VALIDATION (ROBUST) ---
        function parseCoords(coords) {
            if (!coords) return null;
            if (typeof coords === 'object' && !Array.isArray(coords)) {
                const lat = coords.lat ?? coords.latitude;
                const lng = coords.lng ?? coords.longitude;
                const latN = Number(lat);
                const lngN = Number(lng);
                if (isFinite(latN) && isFinite(lngN)) return [latN, lngN];
            }
            if (Array.isArray(coords) && coords.length >= 2) {
                const latN = Number(coords[0]);
                const lngN = Number(coords[1]);
                if (isFinite(latN) && isFinite(lngN)) return [latN, lngN];
            }
            return null;
        }

        function isValidLatLng(point) {
            const coords = parseCoords(point);
            return coords !== null && coords[0] >= -90 && coords[0] <= 90 && coords[1] >= -180 && coords[1] <= 180;
        }

        // --- DATA FETCHING AND PROCESSING ---
        async function initializeTripData() {
            try {
                initializeMap();
                const [itineraryResponse, poiResponse] = await Promise.all([
                    fetch(ITINERARY_URL),
                    fetch(POI_URL)
                ]);

                if (!itineraryResponse.ok) throw new Error('Failed to load itinerary data');
                if (!poiResponse.ok) throw new Error('Failed to load POI data');

                const itineraryDataRaw = await itineraryResponse.json();
                const poiDataRaw = await poiResponse.json();
                itineraryData = itineraryDataRaw.map(item => {
                    // The user wants all times to be treated as "local" to the event's location.
                    // By removing the 'Z' (UTC specifier), we force JavaScript to parse the date
                    // string as if it's in the user's local timezone. This prevents unwanted
                    // timezone conversions and displays the time as it appears in the JSON.
                    const localDatetimeStr = typeof item.datetime === 'string' && item.datetime.endsWith('Z')
                        ? item.datetime.slice(0, -1)
                        : item.datetime;

                    return {
                        ...item,
                        datetime: new Date(localDatetimeStr),
                        coords: parseCoords(item.coords),
                        location: normalizeStr(item.location)
                    };
                });

                pointsOfInterest = Object.keys(poiDataRaw).reduce((acc, city) => {
                    const normalizedCity = normalizeStr(city);
                    acc[normalizedCity] = poiDataRaw[city].map(poi => ({
                        ...poi,
                        coords: parseCoords(poi.coords)
                    }));
                    return acc;
                }, {});

                sortedData = itineraryData.sort((a, b) => a.datetime - b.datetime);

                const byDate = sortedData.reduce((acc, item, index) => {
                    const dateKey = item.datetime.toLocaleDateString('es-ES', {});
                    if (!acc[dateKey]) {
                        acc[dateKey] = { date: item.datetime, events: [] };
                    }
                    acc[dateKey].events.push({ ...item, originalIndex: index });
                    return acc;
                }, {});
                groupedByDay = Object.values(byDate);

                cityStays = calculateCityStays(sortedData);
                populateFilterModal();

                if (Object.keys(cityStays).length > 0) {
                    renderUI();
                } else if (sortedData.length > 0) {
                    throw new Error("Itinerary data loaded, but no city stays could be determined.");
                }

            } catch (error) {
                console.error("Error initializing trip data:", error);
                loadingOverlay.innerHTML = `<div class="text-red-500 p-8 bg-white rounded-lg shadow-xl">Error: ${error.message}</div>`;
            }
        }

        function calculateCityStays(itinerary) {
            const stays = {};
            if (!itinerary || itinerary.length === 0) return stays;

            // 1. Identify the chronological sequence of cities where an overnight stay occurs.
            const stayNodes = [];
            let lastSleepLocation = null;
            itinerary.forEach((event, index) => {
                if (event.type === 'sleep') {
                    if (event.location !== lastSleepLocation) {
                        stayNodes.push({ city: event.location, firstSleepIndex: index });
                    }
                    lastSleepLocation = event.location;
                }
            });

            // 2. Process the itinerary segment for each stay.
            stayNodes.forEach((node, i) => {
                const nextNode = stayNodes[i + 1];

                // a. Determine the start index of the segment.
                // It's the index of the first event with the city's location before the first sleep.
                let stayStartIndex = node.firstSleepIndex;
                const searchArea = itinerary.slice(0, node.firstSleepIndex).reverse();
                const firstEventForCityIndexInReversed = searchArea.findIndex(e => e.location === node.city);
                if (firstEventForCityIndexInReversed !== -1) {
                    stayStartIndex = node.firstSleepIndex - 1 - firstEventForCityIndexInReversed;
                }

                // b. Determine the end index of the segment.
                // It's the start index of the next city's stay.
                let stayEndIndex = itinerary.length;
                if (nextNode) {
                    let nextStayArrivalIndex = nextNode.firstSleepIndex;
                    const searchAreaNext = itinerary.slice(0, nextNode.firstSleepIndex).reverse();
                    const firstEventForNextCityIndexInReversed = searchAreaNext.findIndex(e => e.location === nextNode.city);
                    if (firstEventForNextCityIndexInReversed !== -1) {
                        nextStayArrivalIndex = nextNode.firstSleepIndex - 1 - firstEventForNextCityIndexInReversed;
                    }
                    stayEndIndex = nextStayArrivalIndex;
                }

                const segment = itinerary.slice(stayStartIndex, stayEndIndex);

                // c. Perform calculations for the stay.
                const nights = segment.filter(e => e.type === 'sleep' && e.location === node.city).length;
                if (nights === 0) return; // This isn't a valid overnight stay.

                const arrivalTime = itinerary[stayStartIndex].datetime;

                const dayTrips = [];
                const allSleepCities = stayNodes.map(n => n.city);
                segment.forEach(e => {
                    if (e.type === 'daytrip' && !allSleepCities.includes(e.location)) {
                        if (!dayTrips.some(dt => dt.city === e.location)) {
                            dayTrips.push({ city: e.location, flag: countryFlags[e.location] || '' });
                        }
                    }
                });

                const transportEvent = segment.find(e => e.type === 'flight' || e.type === 'transport');
                const transport = transportEvent ? (transportEvent.type === 'flight' ? 'flight' : 'train') : null;

                // Use a unique key for the stay, e.g., "Tokyo (1)"
                let name = node.city;
                let count = 1;
                while (stays[name]) {
                    name = `${node.city} (${++count})`;
                }

                // --- Day Calculation ---
                const departureEvent = [...segment].reverse().find(e => e.location === node.city && (e.type === 'flight' || e.type === 'transport')) || segment.slice().reverse().find(e => e.location === node.city) || segment[segment.length - 1];
                const departureTime = departureEvent.datetime;

                const dayValues = new Map();

                // Find all daytrip dates
                const dayTripDates = new Set();
                segment.forEach(e => {
                    if (e.type === 'daytrip') {
                        dayTripDates.add(e.datetime.toDateString());
                    }
                });

                // Iterate through each day of the stay and assign its value
                for (let d = new Date(arrivalTime); d <= departureTime; d.setDate(d.getDate() + 1)) {
                    const dayStr = d.toDateString();
                    const isArrivalDay = dayStr === arrivalTime.toDateString();
                    const isDepartureDay = dayStr === departureTime.toDateString();

                    let dayValue = 1.0; // Default full day

                    if (dayTripDates.has(dayStr)) {
                        dayValue = 0.0;
                    } else if (isArrivalDay && isDepartureDay) {
                        const hour = departureTime.getHours();
                        if (hour >= 18) dayValue = 1.0;
                        else if (hour < 13) dayValue = 0.0;
                        else dayValue = 0.5;
                    } else if (isArrivalDay) {
                        const hour = arrivalTime.getHours();
                        if (hour >= 18) dayValue = 0.0;
                        else if (hour > 11) dayValue = 0.5;
                        else dayValue = 1.0;
                    } else if (isDepartureDay) {
                        const hour = departureTime.getHours();
                        if (hour >= 18) dayValue = 1.0;
                        else if (hour < 13) dayValue = 0.0;
                        else dayValue = 0.5;
                    }

                    dayValues.set(dayStr, dayValue);
                }

                let daysCount = 0;
                for (const value of dayValues.values()) {
                    daysCount += value;
                }

                stays[name] = {
                    city: node.city,
                    startTime: arrivalTime,
                    days: String(Math.max(0.5, daysCount)).replace('.5', '½'),
                    nights: String(nights),
                    transportToNext: transport,
                    flag: countryFlags[node.city] || '',
                    dayTrips: dayTrips
                };
            });

            return stays;
        }


        // --- MAP INITIALIZATION ---
        function initializeMap() {
            map = L.map('map').setView([35.6895, 139.6917], 5);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                maxZoom: 19
            }).addTo(map);
            poiLayerGroup = L.layerGroup().addTo(map);
        }

        // --- UI RENDERING ---
        function handleCityClick(clickedCity) {
            const cityStartTime = cityStays[clickedCity]?.startTime;
            if (!cityStartTime) return;

            const targetDayIndex = groupedByDay.findIndex(day =>
                day.date.getUTCFullYear() === cityStartTime.getUTCFullYear() &&
                day.date.getUTCMonth() === cityStartTime.getUTCMonth() &&
                day.date.getUTCDate() === cityStartTime.getUTCDate()
            );

            if (targetDayIndex !== -1 && targetDayIndex !== currentDayIndex) {
                currentDayIndex = targetDayIndex;
                renderDayView();
            }
        }

        function renderUI() {
            renderCityTimeline();
            mainContent.style.display = 'grid';
            renderDayView();
            loadingOverlay.classList.add('hidden');
        }

        function renderCityTimeline() {
            const allCities = Object.keys(cityStays);
            const windowSize = 2;

            if (isMobile) {
                cityPageIndex = Math.max(0, Math.min(cityPageIndex, allCities.length - windowSize));
            }

            const citiesToShow = isMobile && allCities.length > windowSize
                ? allCities.slice(cityPageIndex, cityPageIndex + windowSize)
                : allCities;

            const timelineDiv = document.createElement('div');
            timelineDiv.className = 'city-timeline';
            const containersToAdjust = []; // Keep track of containers

            citiesToShow.forEach(cityKey => {
                const stayInfo = cityStays[cityKey];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'city-timeline-item';
                itemDiv.dataset.city = cityKey;

                let stayHtml = `<div class="stay-info">
                    <div class="stay-info-item" title="${stayInfo.days} Días"><span class="material-symbols-outlined">wb_sunny</span><span class="${String(stayInfo.days).includes('½') ? 'half-day' : ''}">${stayInfo.days}</span></div>`;

                if (stayInfo.dayTrips.length > 0) {
                    stayHtml += `<div class="stay-info-item" title="${stayInfo.dayTrips.length} Excursiones"><span class="material-symbols-outlined">holiday_village</span><span>${stayInfo.dayTrips.length}</span></div>`;
                }

                stayHtml += `<div class="stay-info-item" title="${stayInfo.nights} Noches"><span class="material-symbols-outlined">dark_mode</span><span>${stayInfo.nights}</span></div>
                </div>`;

                const nodeHtml = stayInfo.flag || '';
                itemDiv.innerHTML = `<div class="city-timeline-node">${nodeHtml}</div><div class="city-timeline-label">${stayInfo.city}</div>${stayHtml}`;

                const connectionDiv = document.createElement('div');
                connectionDiv.className = 'timeline-connection';

                const isLastCity = cityKey === allCities[allCities.length - 1];

                if (!isLastCity && stayInfo.transportToNext) {
                    const transportDiv = document.createElement('div');
                    transportDiv.className = 'transport-icon';
                    transportDiv.innerHTML = `<span class="material-symbols-outlined">${transportIcons[stayInfo.transportToNext]}</span>`;
                    connectionDiv.appendChild(transportDiv);
                }

                if (stayInfo.dayTrips.length > 0) {
                    const dayTripsContainer = document.createElement('div');
                    dayTripsContainer.className = 'day-trips-container-org';

                    stayInfo.dayTrips.forEach(trip => {
                        const dayTripItem = document.createElement('div');
                        dayTripItem.className = 'day-trip-item-org';
                        dayTripItem.innerHTML = `
                            <div class="day-trip-icon"><span class="material-symbols-outlined">holiday_village</span></div>
                            <div class="day-trip-label">${trip.city}</div>
                        `;
                        dayTripsContainer.appendChild(dayTripItem);
                    });
                    itemDiv.appendChild(dayTripsContainer);
                    containersToAdjust.push(dayTripsContainer); // Add to list for later processing
                }

                if (connectionDiv.hasChildNodes()) {
                    itemDiv.appendChild(connectionDiv);
                }

                itemDiv.addEventListener('click', () => handleCityClick(cityKey));
                timelineDiv.appendChild(itemDiv);
            });

            cityTimelineContainer.innerHTML = '';
            cityTimelineContainer.appendChild(timelineDiv);

            // Defer the height adjustment until after the DOM has been updated.
            setTimeout(() => {
                containersToAdjust.forEach(dayTripsContainer => {
                    const items = dayTripsContainer.querySelectorAll('.day-trip-item-org');
                    if (items.length > 0) {
                        const lastItem = items[items.length - 1];
                        const lastIcon = lastItem.querySelector('.day-trip-icon');
                        if (lastIcon) {
                            // We want the line to end at the center of the last icon.
                            const containerTop = dayTripsContainer.getBoundingClientRect().top;
                            const lastIconTop = lastIcon.getBoundingClientRect().top;
                            if (lastIconTop > containerTop) { // Ensure calculation is valid
                                const desiredHeight = lastIconTop - containerTop + (lastIcon.offsetHeight / 2);
                                dayTripsContainer.style.setProperty('--line-height', `${desiredHeight}px`);
                            }
                        }
                    }
                });
            }, 0);


            if (isMobile && allCities.length > windowSize) {
                const leftArrow = document.createElement('button');
                leftArrow.className = 'scroll-arrow left';
                leftArrow.innerHTML = `<span class="material-symbols-outlined">arrow_back_ios</span>`;
                leftArrow.disabled = cityPageIndex === 0;
                leftArrow.onclick = () => { if (cityPageIndex > 0) { cityPageIndex--; renderCityTimeline(); } };

                const rightArrow = document.createElement('button');
                rightArrow.className = 'scroll-arrow right';
                rightArrow.innerHTML = `<span class="material-symbols-outlined">arrow_forward_ios</span>`;
                rightArrow.disabled = cityPageIndex >= allCities.length - windowSize;
                rightArrow.onclick = () => { if (cityPageIndex < allCities.length - windowSize) { cityPageIndex++; renderCityTimeline(); } };

                cityTimelineContainer.appendChild(leftArrow);
                cityTimelineContainer.appendChild(rightArrow);
            }

            if (groupedByDay.length > 0) {
                const currentEventTime = groupedByDay[currentDayIndex].date;
                updateCityTimelineActiveState(currentEventTime);
            }
        }

        function renderDayView() {
            if (groupedByDay.length === 0) return;

            const currentDayData = groupedByDay[currentDayIndex];
            const allCities = Object.keys(cityStays);
            const windowSize = 2;

            if (isMobile) {
                const activeCity = getActiveCity(currentDayData.date);
                if (activeCity) {
                    const activeCityIndex = allCities.indexOf(activeCity);
                    if (activeCityIndex !== -1) {
                        let targetIndex = activeCityIndex - 1;
                        const maxIndex = allCities.length > windowSize ? allCities.length - windowSize : 0;
                        targetIndex = Math.max(0, Math.min(targetIndex, maxIndex));
                        if (cityPageIndex !== targetIndex) {
                            cityPageIndex = targetIndex;
                            renderCityTimeline();
                        }
                    }
                }
            }

            const date = currentDayData.date;
            const dayName = date.toLocaleDateString('es-ES', { weekday: 'long' });
            dateDisplay.innerHTML = `
                <h3 class="text-lg font-bold text-slate-900">${capitalizeFirstLetter(dayName)}</h3>
                <p class="text-sm text-slate-500">${date.toLocaleDateString('es-ES', { month: 'long', day: 'numeric' })}</p>`;
            prevDayBtn.disabled = currentDayIndex === 0;
            nextDayBtn.disabled = currentDayIndex === groupedByDay.length - 1;

            itineraryList.innerHTML = '';
            currentDayData.events.forEach(item => {
                const timeString = item.datetime.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: true });
                const container = document.createElement('div');
                container.className = 'timeline-item-container group';

                const hasDetails = item.details && Object.keys(item.details).length > 0 && ['flight', 'flight_arrival', 'transport', 'lodging'].includes(item.type);
                const infoIconHtml = hasDetails ? `<span class="material-symbols-outlined text-slate-400 group-hover:text-emerald-600 transition ml-2" style="font-size: 20px;">info</span>` : '';

                container.innerHTML = `
                    <div class="timeline-line"></div>
                    <div class="timeline-icon">${icons[item.type] || icons.activity}</div>
                    <div class="timeline-content">
                        <p class="text-sm font-semibold text-slate-500">${timeString}</p>
                        <div class="flex items-center">
                            <p class="font-semibold text-lg text-slate-800 mt-1">${item.title}</p>
                            ${infoIconHtml}
                        </div>
                        <p class="text-sm text-slate-600 flex items-center gap-2 mt-1"><span class="material-symbols-outlined" style="font-size: 16px;">location_on</span>${item.location}</p>
                        ${item.duration ? `<div class="flex items-center text-sm text-slate-600 mt-1"><span class="material-symbols-outlined" style="font-size: 16px; margin-right: 8px;">schedule</span><span>${item.duration}</span></div>` : ''}
                    </div>`;

                if (hasDetails) {
                    container.addEventListener('click', () => showDetailsModal(item));
                }

                itineraryList.appendChild(container);
            });
            if (currentDayData.events.length === 0) {
                 itineraryList.innerHTML = `<p class="text-slate-500 italic p-4">No hay eventos programados para este día.</p>`;
            }

            updateMap(currentDayData.events);
            updateCityTimelineActiveState(currentDayData.date);
        }

        function updateMap(events) {
            if (!map) return;
            poiLayerGroup.clearLayers();
            if (mainMarker) {
                try { map.removeLayer(mainMarker); } catch (e) { /* ignore */ }
                mainMarker = null;
            }

            const allCoords = [];
            events.forEach(item => {
                if (isValidLatLng(item.coords)) allCoords.push(item.coords);
            });

            const firstEvent = events[0];
            if (firstEvent) {
                const cityMap = { "Susono": "Hakone", "Narita": "Tokyo", "Gyeongju": "Busan" };
                let poiLookupLocation = cityMap[firstEvent.location] || firstEvent.location;
                if (pointsOfInterest[poiLookupLocation]) {
                    const poisToDisplay = pointsOfInterest[poiLookupLocation].filter(poi =>
                        activeFilters.length === 0 || activeFilters.includes(poi.category)
                    );

                    poisToDisplay.forEach(poi => {
                        if (isValidLatLng(poi.coords)) {
                            allCoords.push(poi.coords);
                            const iconHtml = `<span class="material-symbols-outlined">${poiIcons[poi.category] || 'place'}</span>`;
                            const divIcon = L.divIcon({ className: 'leaflet-div-icon', html: iconHtml, iconSize: [30, 30], iconAnchor: [15, 15] });
                            let popupContent = `<b>${poi.name}</b><br>${poi.category}`;
                            if (poi.maps_url) popupContent += `<br><a href="${poi.maps_url}" target="_blank" rel="noopener noreferrer">Ver en Google Maps</a>`;
                            L.marker(poi.coords, { icon: divIcon }).addTo(poiLayerGroup).bindPopup(popupContent);
                        }
                    });
                }
            }

            const uniqueCoords = allCoords.filter((pt, idx, arr) => arr.findIndex(other => other[0] === pt[0] && other[1] === pt[1]) === idx);

            if (uniqueCoords.length > 0) {
                const bounds = L.latLngBounds(uniqueCoords);
                map.invalidateSize();
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [50, 50], maxZoom: 14 });
                }
            }
        }

        function getActiveCity(currentTime) {
            let activeCity = null;
            const sortedCities = Object.keys(cityStays).sort((a,b) => cityStays[a].startTime - cityStays[b].startTime);
            for (const cityName of sortedCities) {
                if (cityStays[cityName].startTime <= currentTime) {
                    activeCity = cityName;
                }
            }
            return activeCity;
        }

        function updateCityTimelineActiveState(currentTime) {
            document.querySelectorAll('.city-timeline-item').forEach(el => el.classList.remove('active'));
            const activeCity = getActiveCity(currentTime);

            if (activeCity) {
                const activeCityEl = document.querySelector(`.city-timeline-item[data-city="${activeCity}"]`);
                if (activeCityEl) {
                    activeCityEl.classList.add('active');
                }
            }
        }

        // --- Event Handlers ---
        prevDayBtn.addEventListener('click', () => {
            if (currentDayIndex > 0) { currentDayIndex--; renderDayView(); }
        });

        nextDayBtn.addEventListener('click', () => {
            if (currentDayIndex < groupedByDay.length - 1) { currentDayIndex++; renderDayView(); }
        });

        window.addEventListener('resize', () => {
            const newIsMobile = window.innerWidth < LG_BREAKPOINT;
            if (newIsMobile !== isMobile) {
                isMobile = newIsMobile;
                renderCityTimeline();
            }
        });

        // --- Modals ---
        const detailsModal = document.getElementById('details-modal');
        const modalCard = document.getElementById('modal-card');
        const poiModalBtn = document.getElementById('poi-modal-btn');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        const filterModal = document.getElementById('filter-modal');
        const filterModalCard = document.getElementById('filter-modal-card');
        const filterModalBtn = document.getElementById('filter-modal-btn');
        const filterModalCloseBtn = document.getElementById('filter-modal-close-btn');
        const filterApplyBtn = document.getElementById('filter-apply-btn');
        const filterToggleAllBtn = document.getElementById('filter-toggle-all-btn');

        function showPoiModal(location) {
            const cityMap = { "Susono": "Hakone", "Narita": "Tokyo", "Gyeongju": "Busan" };
            let poiLookupLocation = cityMap[location] || location;
            modalTitle.textContent = `Puntos de Interés en ${poiLookupLocation}`;
            let contentHtml = '';
            if (pointsOfInterest[poiLookupLocation]) {
                const groupedPOIs = pointsOfInterest[poiLookupLocation].reduce((acc, poi) => {
                    if (!acc[poi.category]) acc[poi.category] = [];
                    acc[poi.category].push(poi);
                    return acc;
                }, {});

                contentHtml += `<div class="space-y-4">`;
                for (const category in groupedPOIs) {
                    contentHtml += `
                        <details class="poi-category-details group" open>
                            <summary class="poi-category-summary list-none flex justify-between items-center cursor-pointer p-3 bg-slate-100 rounded-lg hover:bg-slate-200 transition">
                                <div class="flex items-center">
                                    <span class="material-symbols-outlined text-slate-600 mr-3">${poiIcons[category] || 'place'}</span>
                                    <span class="font-semibold text-slate-700">${category}</span>
                                    <span class="text-sm text-slate-500 ml-2">(${groupedPOIs[category].length})</span>
                                </div>
                                <span class="material-symbols-outlined transition-transform duration-300 group-open:rotate-180">expand_more</span>
                            </summary>
                            <div class="poi-list-modal p-3 space-y-3">
                                ${groupedPOIs[category].map(poi => `
                                    <div class="poi-item-modal border-l-2 border-slate-200 pl-4 py-2">
                                        <p class="font-semibold text-slate-800">${poi.name}</p>
                                        <p class="text-sm text-slate-600">${poi.description}</p>
                                        ${poi.maps_url ? `<a href="${poi.maps_url}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 text-sm text-emerald-600 hover:text-emerald-800 font-semibold mt-1">Ver en Google Maps <span class="material-symbols-outlined" style="font-size: 16px;">open_in_new</span></a>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </details>`;
                }
                contentHtml += '</div>';
            } else {
                 contentHtml = `<p class="text-slate-500 italic">No hay Puntos de Interés para mostrar en ${poiLookupLocation}.</p>`;
            }
            modalContent.innerHTML = contentHtml;
            openModal();
        }

        function linkify(key, value) {
            if (typeof value !== 'string') {
                return `<p><strong class="text-slate-600 font-semibold">${key}:</strong> <span class="text-slate-800">${value}</span></p>`;
            }

            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const urls = value.match(urlRegex);

            if (!urls) {
                return `<p><strong class="text-slate-600 font-semibold">${key}:</strong> <span class="text-slate-800">${value}</span></p>`;
            }

            // Case 1: Special key and value is a URL.
            if ((key === 'Reserva' || key === 'Confirmation' || key.toLowerCase().includes('link')) && urls.length === 1 && value.trim() === urls[0]) {
                return `<p><a href="${value}" target="_blank" rel="noopener noreferrer" class="text-emerald-600 hover:underline font-semibold">${key}</a></p>`;
            }

            // Case 2: Generic value with URLs inside.
            const linkedValue = value.replace(urlRegex, (url) => `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-emerald-600 hover:underline">${url}</a>`);
            return `<p><strong class="text-slate-600 font-semibold">${key}:</strong> <span class="text-slate-800">${linkedValue}</span></p>`;
        }

        function showDetailsModal(item) {
            modalTitle.textContent = item.title;
            let contentHtml = '<div class="space-y-3 p-4 bg-slate-50 rounded-lg shadow-inner">';
            if (item.details && Object.keys(item.details).length > 0) {
                for (const [key, value] of Object.entries(item.details)) {
                    contentHtml += linkify(key, value);
                }
            } else {
                contentHtml += '<p class="text-slate-500 italic">No hay detalles para mostrar.</p>';
            }
            contentHtml += '</div>';
            modalContent.innerHTML = contentHtml;
            openModal();
        }

        function openModal() {
            detailsModal.classList.remove('hidden');
            detailsModal.classList.add('flex');
            setTimeout(() => modalCard.classList.remove('scale-95'), 10);
        }

        function hideDetailsModal() {
            modalCard.classList.add('scale-95');
            setTimeout(() => detailsModal.classList.add('hidden'), 200);
        }

        modalCloseBtn.addEventListener('click', hideDetailsModal);
        detailsModal.addEventListener('click', (e) => { if (e.target === detailsModal) hideDetailsModal(); });

        poiModalBtn.addEventListener('click', () => {
            const mainLocation = groupedByDay[currentDayIndex]?.events[0]?.location;
            if (mainLocation) showPoiModal(mainLocation);
        });

        filterModalBtn.addEventListener('click', () => {
            updateToggleAllButtonState();
            filterModal.classList.remove('hidden');
            filterModal.classList.add('flex');
            setTimeout(() => filterModalCard.classList.remove('scale-95'), 10);
        });

        function hideFilterModal() {
            filterModalCard.classList.add('scale-95');
            setTimeout(() => filterModal.classList.add('hidden'), 200);
        }

        filterModalCloseBtn.addEventListener('click', hideFilterModal);
        filterModal.addEventListener('click', (e) => { if (e.target === filterModal) hideFilterModal(); });

        function updateToggleAllButtonState() {
            const checkboxes = document.querySelectorAll('#filter-categories input[type="checkbox"]');
            const checkedCount = document.querySelectorAll('#filter-categories input[type="checkbox"]:checked').length;
            const icon = document.getElementById('filter-toggle-all-icon');
            const text = document.getElementById('filter-toggle-all-text');

            if (checkedCount === checkboxes.length) {
                icon.textContent = 'check_box';
                text.textContent = 'Deseleccionar todo';
            } else if (checkedCount === 0) {
                icon.textContent = 'check_box_outline_blank';
                text.textContent = 'Seleccionar todo';
            } else {
                icon.textContent = 'indeterminate_check_box';
                text.textContent = 'Seleccionar todo';
            }
        }

        filterToggleAllBtn.addEventListener('click', () => {
            const checkboxes = document.querySelectorAll('#filter-categories input[type="checkbox"]');
            const checkedCount = document.querySelectorAll('#filter-categories input[type="checkbox"]:checked').length;
            const shouldSelectAll = checkedCount < checkboxes.length;

            checkboxes.forEach(cb => cb.checked = shouldSelectAll);
            updateToggleAllButtonState();
        });

        filterApplyBtn.addEventListener('click', () => {
            const selectedCategories = Array.from(document.querySelectorAll('#filter-categories input:checked')).map(cb => cb.value);
            activeFilters = selectedCategories;
            renderDayView(); // This will re-render the map
            hideFilterModal();
        });

        function populateFilterModal() {
            const filterCategoriesContainer = document.getElementById('filter-categories');
            if (!filterCategoriesContainer) return;

            const allPois = Object.values(pointsOfInterest).flat();
            const uniqueCategories = [...new Set(allPois.map(poi => poi.category).filter(Boolean))].sort();

            filterCategoriesContainer.innerHTML = uniqueCategories.map(category => {
                const checkboxId = `filter-${category.replace(/[^a-zA-Z0-9]/g, '-')}`;
                const isChecked = activeFilters.length === 0 || activeFilters.includes(category);
                return `
                    <label for="${checkboxId}" class="flex items-center space-x-3 cursor-pointer hover:bg-slate-50 p-2 rounded-md">
                        <input type="checkbox" id="${checkboxId}" name="poi-category" value="${category}" ${isChecked ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500" onchange="updateToggleAllButtonState()">
                        <span class="text-slate-700">${category}</span>
                    </label>
                `;
            }).join('');
        }


        // --- Start the Application ---
        initializeTripData();

    </script>
</body>
</html>
